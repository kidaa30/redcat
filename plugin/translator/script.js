//ISO 639-1 (alpha2)

//in their respectives languages
var local_names = {"aa":"Afaraf","ab":"Аҧсуа","ae":"Avesta","af":"Afrikaans","ak":"Akan","am":"አማርኛ","an":"Aragonés","ar":"‫العربية","as":"অসমীয়া","av":"авар мацӀ","ay":"Aymar aru","az":"Azərbaycan dili","ba":"башҡорт теле","be":"Беларуская","bg":"български език","bh":"भोजपुरी","bi":"Bislama","bm":"Bamanankan","bn":"বাংলা","bo":"བོད་ཡིག","br":"Brezhoneg","bs":"Bosanski jezik","ca":"Català","ce":"нохчийн мотт","ch":"Chamoru","co":"Corsu","cr":"ᓀᐦᐃᔭᐍᐏᐣ","cs":"Česky","cu":"Словѣньскъ","cv":"чӑваш чӗлхи","cy":"Cymraeg","da":"Dansk","de":"Deutsch","dv":"‫ދިވެހި","dz":"རྫོང་ཁ","ee":"Ɛʋɛgbɛ","el":"Ελληνικά","en":"English","eo":"Esperanto","es":"Español","et":"Eesti keel","eu":"Euskara","fa":"‫فارسی","ff":"Fulfulde","fi":"Suomen kieli","fj":"Vosa Vakaviti","fo":"Føroyskt","fr":"Français","fy":"Frysk","ga":"Gaeilge","gd":"Gàidhlig","gl":"Galego","gn":"Avañe'ẽ","gu":"ગુજરાતી","gv":"Ghaelg","ha":"‫هَوُسَ","he":"‫עברית","hi":"हिन्दी","ho":"Hiri Motu","hr":"Hrvatski","ht":"Kreyòl ayisyen","hu":"magyar","hy":"Հայերեն","hz":"Otjiherero","ia":"Interlingua","id":"Bahasa Indonesia","ie":"Interlingue","ig":"Igbo","ii":"ꆇꉙ","ik":"Iñupiaq","io":"Ido","is":"Íslenska","it":"Italiano","iu":"ᐃᓄᒃᑎᑐᑦ","ja":"日本語 (にほんご)","jv":"Basa Jawa","ka":"ქართული","kg":"KiKongo","ki":"Gĩkũyũ","kj":"Kuanyama","kk":"Қазақ тілі","kl":"Kalaallisut","km":"ភាសាខ្មែរ","kn":"ಕನ್ನಡ","ko":"한국어 (韓國語)","kr":"Kanuri","ks":"कश्मीरी","ku":"Kurdî","kv":"коми кыв","kw":"Kernewek","ky":"кыргыз тили","la":"Latine","lb":"Lëtzebuergesch","lg":"Luganda","li":"Limburgs","ln":"Lingála","lo":"ພາສາລາວ","lt":"Lietuvių kalba","lu":"kiluba","lv":"Latviešu valoda","mg":"Fiteny malagasy","mh":"Kajin M̧ajeļ","mi":"Te reo Māori","mk":"македонски јазик","ml":"മലയാളം","mn":"Монгол","mo":"лимба молдовеняскэ","mr":"मराठी","ms":"Bahasa Melayu","mt":"Malti","my":"ဗမာစာ","na":"Ekakairũ Naoero","nb":"Norsk bokmål","nd":"isiNdebele","ne":"नेपाली","ng":"Owambo","nl":"Nederlands","nn":"Norsk nynorsk","no":"Norsk","nr":"Ndébélé","nv":"Diné bizaad","ny":"ChiCheŵa","oc":"Occitan","oj":"ᐊᓂᔑᓈᐯᒧᐎᓐ","om":"Afaan Oromoo","or":"ଓଡ଼ିଆ","os":"Ирон æвзаг","pa":"ਪੰਜਾਬੀ","pi":"पािऴ","pl":"Polski","ps":"‫پښتو","pt":"Português","qu":"Runa Simi","rm":"Rumantsch grischun","rn":"kiRundi","ro":"Română","ru":"русский язык","rw":"Kinyarwanda","sa":"संस्कृतम्","sc":"sardu","sd":"सिन्धी","se":"Davvisámegiella","sg":"Yângâ tî sängö","si":"සිංහල","sk":"Slovenčina","sl":"Slovenščina","sm":"Gagana fa'a Samoa","sn":"chiShona","so":"Soomaaliga","sq":"Shqip","sr":"српски језик","ss":"SiSwati","st":"seSotho","su":"Basa Sunda","sv":"Svenska","sw":"Kiswahili","ta":"தமிழ்","te":"తెలుగు","tg":"тоҷикӣ","th":"ไทย","ti":"ትግርኛ","tk":"Türkmen","tl":"Tagalog","tn":"seTswana","to":"faka Tonga","tr":"Türkçe","ts":"xiTsonga","tt":"татарча","tw":"Twi","ty":"Reo Mā`ohi","ug":"Uyƣurqə","uk":"українська мова","ur":"‫اردو","uz":"O'zbek","ve":"tshiVenḓa","vi":"Tiếng Việt","vo":"Volapük","wa":"Walon","wo":"Wollof","xh":"isiXhosa","yi":"‫ייִדיש","yo":"Yorùbá","za":"Saɯ cueŋƅ","zh":"中文, 汉语, 漢語","zu":"isiZulu"};
//in english
//var local_names = {"aa":"Afar","ab":"Abkhazian","ae":"Avestan","af":"Afrikaans","ak":"Akan","am":"Amharic","an":"Aragonese","ar":"Arabic","as":"Assamese","av":"Avaric","ay":"Aymara","az":"Azerbaijani","ba":"Bashkir","be":"Belarusian","bg":"Bulgarian","bh":"Bihari","bi":"Bislama","bm":"Bambara","bn":"Bengali","bo":"Tibetan","br":"Breton","bs":"Bosnian","ca":"Catalan","ce":"Chechen","ch":"Chamorro","co":"Corsican","cr":"Cree","cs":"Czech","cu":"Old Church Slavonic","cv":"Chuvash","cy":"Welsh","da":"Danish","de":"German","dv":"Divehi","dz":"Dzongkha","ee":"Ewe","el":"Greek","en":"English","eo":"Esperanto","es":"Spanish","et":"Estonian","eu":"Basque","fa":"Persian","ff":"Fulah","fi":"Finnish","fj":"Fijian","fo":"Faroese","fr":"French","fy":"Western Frisian","ga":"Irish","gd":"Scottish Gaelic","gl":"Galician","gn":"Guarani","gu":"Gujarati","gv":"Manx","ha":"Hausa","he":"Hebrew","hi":"Hindi","ho":"Hiri Motu","hr":"Croatian","ht":"Haitian","hu":"Hungarian","hy":"Armenian","hz":"Herero","ia":"Interlingua","id":"Indonesian","ie":"Interlingue","ig":"Igbo","ii":"Sichuan Yi","ik":"Inupiaq","io":"Ido","is":"Icelandic","it":"Italian","iu":"Inuktitut","ja":"Japanese","jv":"Javanese","ka":"Georgian","kg":"Kongo","ki":"Kikuyu","kj":"Kwanyama","kk":"Kazakh","kl":"Kalaallisut","km":"Khmer","kn":"Kannada","ko":"Korean","kr":"Kanuri","ks":"Kashmiri","ku":"Kurdish","kv":"Komi","kw":"Cornish","ky":"Kirghiz","la":"Latin","lb":"Luxembourgish","lg":"Ganda","li":"Limburgish","ln":"Lingala","lo":"Lao","lt":"Lithuanian","lu":"Luba-Katanga","lv":"Latvian","mg":"Malagasy","mh":"Marshallese","mi":"Māori","mk":"Macedonian","ml":"Malayalam","mn":"Mongolian","mo":"Moldavian","mr":"Marathi","ms":"Malay","mt":"Maltese","my":"Burmese","na":"Nauru","nb":"Norwegian Bokmål","nd":"North Ndebele","ne":"Nepali","ng":"Ndonga","nl":"Dutch","nn":"Norwegian Nynorsk","no":"Norwegian","nr":"South Ndebele","nv":"Navajo","ny":"Chichewa","oc":"Occitan","oj":"Ojibwa","om":"Oromo","or":"Oriya","os":"Ossetian","pa":"Panjabi","pi":"Pāli","pl":"Polish","ps":"Pashto","pt":"Portuguese","qu":"Quechua","rm":"Romansh","rn":"Kirundi","ro":"Romanian","ru":"Russian","rw":"Kinyarwanda","sa":"Sanskrit","sc":"Sardinian","sd":"Sindhi","se":"Northern Sami","sg":"Sango","si":"Sinhalese","sk":"Slovak","sl":"Slovene","sm":"Samoan","sn":"Shona","so":"Somali","sq":"Albanian","sr":"Serbian","ss":"Swati","st":"Sotho","su":"Sundanese","sv":"Swedish","sw":"Swahili","ta":"Tamil","te":"Telugu","tg":"Tajik","th":"Thai","ti":"Tigrinya","tk":"Turkmen","tl":"Tagalog","tn":"Tswana","to":"Tonga","tr":"Turkish","ts":"Tsonga","tt":"Tatar","tw":"Twi","ty":"Tahitian","ug":"Uighur","uk":"Ukrainian","ur":"Urdu","uz":"Uzbek","ve":"Venda","vi":"Viêt Namese","vo":"Volapük","wa":"Walloon","wo":"Wolof","xh":"Xhosa","yi":"Yiddish","yo":"Yoruba","za":"Zhuang","zh":"Chinese","zu":"Zulu"};
//in french
//var local_names = {"aa":"Afar","ab":"Abkhaze","ae":"Avestique","af":"Afrikaans","ak":"Akan","am":"Amharique","an":"Aragonais","ar":"Arabe","as":"Assamais","av":"Avar","ay":"Aymara","az":"Azéri","ba":"Bachkir","be":"Biélorusse","bg":"Bulgare","bh":"Bihari","bi":"Bichelamar","bm":"Bambara","bn":"Bengalî","bo":"Tibétain","br":"Breton","bs":"Bosnien","ca":"Catalan","ce":"Tchétchène","ch":"Chamorro","co":"Corse","cr":"Cri","cs":"Tchèque","cu":"Vieux slave","cv":"Tchouvache","cy":"Gallois","da":"Danois","de":"Allemand","dv":"Dhivehi","dz":"Dzongkha","ee":"Ewe","el":"Grec moderne","en":"Anglais","eo":"Espéranto","es":"Espagnol","et":"Estonien","eu":"Basque","fa":"Persan","ff":"Peul","fi":"Finnois","fj":"Fidjien","fo":"Féringien","fr":"Français","fy":"Frison","ga":"Irlandais","gd":"Écossais","gl":"Galicien","gn":"Guarani","gu":"Gujarâtî","gv":"Mannois","ha":"Haoussa","he":"Hébreu","hi":"Hindî","ho":"Hiri motu","hr":"Croate","ht":"Créole haïtien","hu":"Hongrois","hy":"Arménien","hz":"Héréro","ia":"Interlingua","id":"Indonésien","ie":"Occidental","ig":"Igbo","ii":"Yi","ik":"Inupiaq","io":"Ido","is":"Islandais","it":"Italien","iu":"Inuktitut","ja":"Japonais","jv":"Javanais","ka":"Géorgien","kg":"Kikongo","ki":"Kikuyu","kj":"Kuanyama","kk":"Kazakh","kl":"Kalaallisut","km":"Khmer","kn":"Kannara","ko":"Coréen","kr":"Kanouri","ks":"Kashmiri","ku":"Kurde","kv":"Komi","kw":"Cornique","ky":"Kirghiz","la":"Latin","lb":"Luxembourgeois","lg":"Ganda","li":"Limbourgeois","ln":"Lingala","lo":"Lao","lt":"Lituanien","lu":"Luba-katanga","lv":"Letton","mg":"Malgache","mh":"Marshallais","mi":"Maori de Nouvelle-Zélande","mk":"Macédonien","ml":"Malayalam","mn":"Mongol","mo":"Moldave","mr":"Marâthî","ms":"Malais","mt":"Maltais","my":"Birman","na":"Nauruan","nb":"Norvégien Bokmål","nd":"Ndébélé du Nord","ne":"Népalais","ng":"Ndonga","nl":"Néerlandais","nn":"Norvégien Nynorsk","no":"Norvégien","nr":"Ndébélé du Sud","nv":"Navajo","ny":"Chichewa","oc":"Occitan","oj":"Ojibwé","om":"Oromo","or":"Oriya","os":"Ossète","pa":"Panjâbî","pi":"Pâli","pl":"Polonais","ps":"Pachto","pt":"Portugais","qu":"Quechua","rm":"Romanche","rn":"Kirundi","ro":"Roumain","ru":"Russe","rw":"Kinyarwanda","sa":"Sanskrit","sc":"Sarde","sd":"Sindhi","se":"Same du Nord","sg":"Sango","si":"Cingalais","sk":"Slovaque","sl":"Slovène","sm":"Samoan","sn":"Shona","so":"Somali","sq":"Albanais","sr":"Serbe","ss":"Siswati","st":"Sotho du Sud","su":"Soundanais","sv":"Suédois","sw":"Swahili","ta":"Tamoul","te":"Télougou","tg":"Tadjik","th":"Thaï","ti":"Tigrinya","tk":"Turkmène","tl":"Tagalog","tn":"Tswana","to":"Tongien","tr":"Turc","ts":"Tsonga","tt":"Tatar","tw":"Twi","ty":"Tahitien","ug":"Ouïghour","uk":"Ukrainien","ur":"Ourdou","uz":"Ouzbek","ve":"Venda","vi":"Vietnamien","vo":"Volapük","wa":"Wallon","wo":"Wolof","xh":"Xhosa","yi":"Yiddish","yo":"Yoruba","za":"Zhuang","zh":"Chinois","zu":"Zoulou"};

var escape = function(str) {
	if(str)
		return str.replace(/&/g,'&amp;').replace(/>/g,'&gt;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
};
var nl2br = function(str) {
	if(str)
		return str.replace("\n",'<br />');
};
var messageService = function(method, params,callback,error_handler) {
	$.post('RPC',{
			"method":method,
			"params":params,
			"id":Math.random()
		},
		function(obj) {
			if(obj.error) {
				error_handler ? error_handler(obj.error) : NotificationObj.showError(obj.error.message + "	" + method);
			} else {
				callback(obj.result);
			}
		},
		"json"
	);		 
};
var NotificationObj = {
	init: function(){
		$('#errors #hideBtn').click(this.hideError);
		$('#messages #hideBtn').click(this.hideMessage);
	},
	hideAll: function(){
		this.hideError();
		this.hideMessage();
	},
	showError: function(msg){
		$('<span />').html("<br />" + msg).appendTo('#errors p');
		$('#errors').fadeIn();
		$('#next').hide();
	},
	hideError: function(){
		$('#errors').fadeOut();
	},
	showMessage: function(msg){
		$('#messages').stop().css({opacity:0});
		$('#messages span').text(msg);
		$('#messages').animate({opacity:1},300, function(){ $('#messages').animate({opacity:0}, 3000); });
	},
	hideMessage: function(){
		$('#messages').css({opacity:0});
	}
};


var lang = window.location.href.match(/lg=((?:[a-z][a-z0-9_]*))/);
if(lang){
	lang = lang[1];
}
var cat_id = window.location.href.match(/cat_id=(\d+)/);
var catName = window.location.href.match(/name=((?:[a-z][a-z0-9_]*))/);
if(catName)
	catName = catName[1];
else
	catName = 'messages';
if(cat_id)
	cat_id = parseInt(cat_id[1]);
var limitation,page,count,pages,sort,order;
limitation = 15;
page = window.location.href.match(/page=(\d+)/);
sort = window.location.href.match(/sort=((?:[a-z][a-z0-9_]*))/);
order = window.location.href.match(/order=((?:[a-z][a-z0-9_]*))/);
if(order)
	order = order[1];
else
	order = 'msgid';
if(sort)
	sort = sort[1];
else
	sort = 'asc';
if(page)
	page = parseInt(page[1]);
else
	page = 1;

// Get the stored catalogues
var getCatalogues = function(catId){
	 messageService('getCatalogues', [lang], function(data){
		if (data.length == 0){
			NotificationObj.showError("No PO Catalalogues Found.");
			return;
		}
		for (var i = 0; i<data.length; ++i){
			var opt = $("<option />");
			opt.attr('data-name',data[i]).text(data[i]);
			if(data[i]==catName){
				opt.attr('selected','selected');
			}
			opt.appendTo($('#catalogue_list'));
			if (data[i] == catName) {
				$('#cat_name').text(data[i]);
			}
		}
	});
	
};
var getStats = function( catId ){
	var $container = $('#nav div.data');
	messageService("getStats", [lang,catId], function(data){
		var table = $('<table><tbody> </tbody></table>');
		$container.html(table);
		for (var i = 0; i<data.length; ++i){
			var name = data[i].name;
			var html = ''
				+ '<tr><td>'
				+ '<div class="progressbar"> <div class="inner"> </div> </div>'
				+ '</td><td>'
				+ '<span class="percent"></span> - <span class="translated" ></span> of <span class="total"></span>'
				+ '</td><td>'
				+ '<button class="update_cat" data-id="'+data[i].id+'">update</button>'
				+ '</td><td>'
				+ '<button class="compile_cat" data-id="'+data[i].id+'">compile</button>'
				+ '</td></tr>';
 
			table.find('tbody').append(html);
			var $row = table.find('tr:last');
			
			var updater;
			updater = function(cid,t){
				messageService('importCatalogue',[cid,t],function(data){
					if(data.timeout){
						updater(cid,data.timeout);
						$('.atline').text('parsing line: '+data.timeout);
					}
					else{
						$('.atline').remove();
						window.location.href = window.location.href;
						$('#cat_box').css('opacity',1);
					}
				});
			};
			
			$row.find('button.update_cat').click(function(){
					$('#cat_box').css('opacity',0.2);
					$('body').append('<div class="atline" style="z-index:10;position:absolute;top:0;left:0;"></div>');
					updater($(this).attr('data-id'),false);
			});
			$row.find('button.compile_cat').click(function(){
					$('body').css('opacity',0.2);
					messageService('exportCatalogue',[$(this).attr('data-id')],function(){
						$('body').css('opacity',1);
					});
			});
			
			$row.find('.inner')
				.css( 'width',
					$row.find('.progressbar').width()	* 
					( data[i].translated_count / (data[i].message_count-1))
				);
			
			$row.find('.translated').text(data[i].translated_count);
			$row.find('.total').text(data[i].message_count-1);
			var percent = (data[i].translated_count!='0'?parseInt(data[i].translated_count / (data[i].message_count-1) *100):'0') + " %";
			$row.find('.percent').text(percent);
		}
	});
};

$(function(){
	NotificationObj.init();
	$.get('edit.html',function(html){
		var loadEdition = function(){
			$('#body_w').height('470px').html(html);		
			var msgs;
			messageService('getCountMessages',[lang,cat_id],function(total){
				pages = Math.ceil(total/limitation);
				$('#pagination').pagination({
					pages: pages,
					currentPage: page,
					cssStyle: 'compact-theme',
					onPageClick: function(pageNumber, event){
						event.preventDefault();
						var nhref = window.location.href;
						if(nhref.match(/page=(\d+)/))
								nhref = nhref.replace('page='+page,'page='+pageNumber);
						else
								nhref += '&page='+pageNumber;
						window.location.href = nhref;
					}
				});
			});

			var moveBy = function(num) {
				var moveTo = getCurrentMessage() + num;
				moveTo < msgs.length && moveTo >= 0 && selectMessage(moveTo);
			};

			var selectMessage = function (index) {
				//beforeBlur();
				$('#msg_table').find('tbody tr.selected').removeClass('selected');
				var arr_index = $('#msg_table').find('tbody tr:eq(' +(index)+ ')').addClass('selected').data('index');
				fillEditBar(arr_index);
				setScroll();
			};

			var getCurrentMessage = function() {
				return $('#msg_table tr.selected').prevAll().length;
			};
			
			var beforeBlur = function(){
				if ( !$('#msg_table tr.selected').length ) return;
				var $row = $('#msg_table tr:eq(' + getCurrentMessage() + ')');
				var msg = msgs[$row.data('index')];
				var dirty = $('#msgstr').val() != msg.msgstr || $('#comments').val() != msg.comments || $('#fuzz').prop('checked') != msg.fuzzy;
				if (dirty) {
					msg.msgstr = $('#msgstr').val().replace(/\n+$/,'');
					msg.fuzzy = $('#fuzz').prop('checked');
					msg.comments = $('#comments').val();
					$row.trigger('sync');
					messageService('updateMessage', [msg.id, msg.comments, msg.msgstr, msg.fuzzy],function(){
						getStats(cat_id);
					});
				}
			};
			
			var setScroll = function() {
				var ot = $('#msg_table tr.selected').position().top - $('#msg_table').position().top;
				var rh = $('#msg_table tr.selected').height();
				var sh = $('#scroll_container').height();
				var st = $('#scroll_container').scrollTop();
				if(ot < st) {
					$('#scroll_container').scrollTop(ot);
				}
				if(ot + rh - sh > st) {
					$('#scroll_container').scrollTop(ot+rh-sh);
				}
			};
			var sync = function () {

				var $row2 = $(this);
				var msg2 = msgs[$row2.data("index")];
				$row2.find('td.msgid div').text(msg2.msgid).end().find('td.msgstr div').text(msg2.msgstr);
				msg2.msgstr == "" ? $row2.addClass('empty') : $row2.removeClass('empty');
				msg2.fuzzy == 1 ? $row2.addClass('f').find('.fuzzy').text('F') : $row2.removeClass('f').find('.fuzzy').text('');
				msg2.isObsolete && $row2.addClass('d').find('.depr').text('D');
			};
			var renderRowAsString = function(obj) {
				var tr_class = "" 
					+ (!obj.msgstr.length ? 'empty ' : '')
					+ (obj.fuzzy == 1 ? 'f ' : '')
					+ (obj.isObsolete ? 'd ' : ''); 
				return	''
					+	'<tr class="' + tr_class + '"><td class="msgid"><div><span>'
					+ escape(obj.msgid) + '</span></div></td>'
					+ '<td class="msgstr"><div>'
					+ (obj.msgstr?escape(obj.msgstr):'') + '</div></td>'
					+ '<td class="fuzzy">'
					+ (obj.fuzzy == 1 ? 'F' : '')
					+ '</td>'
					+ '<td class="depr">'
					+ (obj.isObsolete ? 'D' : '')
					+ '</td>';
			}

			// Fill the Edit Bar with the selected message
			var fillEditBar = function(index){
				var msg = msgs[index];
				$('#ref_data').html( nl2br(escape(msg.reference)) || '-' );
				$('#com_data').html( nl2br(escape(msg.extractedComments)) || '-' );
				$('#update_data').html( msg.updatedAt || '-' );
				$('#comments').val(msg.comments);
				$('#msgid').html( nl2br(escape(msg.msgid)) || "-" );
				$('#msgstr').val(msg.msgstr?msg.msgstr:'');
				( msg.fuzzy == 1 ) ? $('#fuzz').prop('checked',true) : $('#fuzz').prop('checked',false);
				$('#edit_id').attr( 'value', msg.id );
			};
				
			getCatalogues(cat_id);
			getStats(cat_id);
			
			$('#msg_table_head thead th').click(function() {
				var column_index = $(this).closest('thead').find('th').index(this);
				var direction = !!$(this).hasClass('sort-desc') || !$(this).hasClass('sort-asc');
				var nOrder = $(this).attr('class').split(' ')[0];
					if(pages==1){						
						$(this).siblings().andSelf().removeClass('sort-asc').removeClass('sort-desc');
						$(this).addClass(direction ? 'sort-asc' : 'sort-desc');
						$('#msg_table').tsort(column_index,direction);
					}
					else{
						var nhref = window.location.href;
						if(nhref.match(/order=((?:[a-z][a-z0-9_]*))/))
								nhref = nhref.replace('order='+order,'order='+nOrder);
						else
								nhref += '&order='+nOrder;
						if(nhref.match(/sort=((?:[a-z][a-z0-9_]*))/))
								nhref = nhref.replace('sort='+sort,'sort='+(direction?'asc':'desc'));
						else
								nhref += '&sort='+(direction?'asc':'desc');
						window.location.href = nhref;
					}
			});
			
			// Add toggle effect
			$('#edit_bar .block h3 a.expand').click(function(){
				$(this).parents('.block').find('.data').toggle('fast');
			}).parents('.block').find('.data').toggle();
			
			// Add rollover effect to Side Bar
			var left = $('div.block').offset().left;
			var top = $('div.block').offset().top + $('div.block').height();
			$('body').on("mouseover", '#ref_head',function(){
				$('#ref_data').css({'left':left, 'top':top}).fadeIn('fast');
			}).on("mouseout", '#ref_head',function(){
				$('#ref_data').fadeOut();
			});
			$('body').on("mouseover", '#update_head',function(){
				$('#update_data').css({'left':left, 'top':top}).fadeIn('fast');
			}).on("mouseout",'#update_head', function(){
				$('#update_data').fadeOut();
			});
			$('body').on("mouseover", '#src_com_head',function(){
				$('#com_data').css({'left':left, 'top':top}).fadeIn('fast');
			}).on("mouseout", '#src_com_head',function(){
				$('#com_data').fadeOut();
			});
			
			$(this).resize(function() {
				var w = $(this).width();
				var h = $(this).height();
				var l = $('#message_container').offset().left;
				$('#message_container').css({width:w-l});
				$('#msg_table,#msg_table_head').css({width:w-l-20});
			}).resize();
			
			$('#clean_obsolete').click(function(e){
				$('body').css('opacity',0.2);
				e.preventDefault();
				messageService('cleanObsolete',[],function(){
					window.location.href = window.location.href;
				});
				return false;
			});
			
			$('#loading_indicator').show();
			if ($('#errors span').text() != "") return;
			messageService('getMessages',[lang,cat_id,page,order,sort],function(d){
				msgs = d; // save data to global messages
				if (msgs && msgs.length){
					var $tbody = $('#msg_table tbody').empty(), html="";
					
					$.each(msgs,function(i,e){
						html += renderRowAsString(e);
					})
					$tbody.append(html)
						.find('tr')
						.each(function(i,e){
							$(e).data('index',i)
							.bind('sync',sync);
						});
					selectMessage(0);
				}
				$('#loading_indicator').hide();
			});
			
			//init events
			$('#msg_table td').click(function(){
				selectMessage($(this).parent('tr').prevAll().length );
			});
			$('#next').click(function(e){
				e.preventDefault();
				moveBy(1);
				$('#msgstr').focus();
			});
			$('#fuzz').click(function(){
				beforeBlur();
			});
			$('#msgstr').blur(function(e){
				beforeBlur();
			});
			$(document).keydown(function(e){
				var nt = e.target.type,code;
				if( !(nt == 'input' || nt == 'textarea') ) {
					code = e.which || e.keyCode;
					switch(e.which || e.keyCode) {
						case 37:
						case 38:
							moveBy(-1);
							e.preventDefault();
						break;
						case 39:
						case 40:
							moveBy(1);
							e.preventDefault();
						break;
					}
				}
			});
			
			$('#msg_table_head thead th.'+order).addClass('sort-'+sort);
		};
		var flags = $('.flags');
		if(lang){
			$('body').append('<div class="selected-lang"><img width="16" height="16" src="../../img/langs/'+lang+'.png" /> '+local_names[lang]+'</div');
		}
		for(k in local_names){
			flags.append('<a href="?lg='+k+'" data-lang="'+k+'"'+(lang&&lang==k?' class="selected"':'')+'><img width="16" height="16" src="../../img/langs/'+k+'.png" /> '+local_names[k]+'</a>');
		}
		
		var countPotMessages = function(){
			messageService('countPotMessages',[],function(count){
				if(count)
					$('#counter').text('('+(count-1)+' messages)');
			});
		};
		countPotMessages();
		$('#makepot').click(function(e){
				e.preventDefault();
				$('body').css('opacity',0.2);
				messageService('makePot',[],function(){
					countPotMessages();
					$('body').css('opacity',1);
				});
				return false;
		});
		
		if(lang){
			loadEdition();
		}
	});
});